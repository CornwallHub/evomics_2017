- hosts: all
  vars:
    - source_dir: /home/genomics/software/.source
    - software_dir: /home/genomics/software
    - workshop_dir: /home/genomics/workshop_materials
    # sha-512 hash
    - genomics_user_password: $6$xsb/UrhJ$sxievieZ7erTF93MwiBEZqm/mIpTVlTd3uhYGY2Urt5qoGapG3ZEU6NrGMOYd7QUnFfXhgDn12OPxDuxb20dB0
    # mysql native hash - SELECT PASSWORD("password") - also need to set in stacks_web.yaml
    - stacks_user_password: '*39094635b39efded76637451cdbd294d41865007'
    
  pre_tasks:
    # Set up the workshop user with a SHA-512 crypted password using mkpasswd
    - name: Create genomics Workshop User
      user: name=genomics group=workshop comment="Genomics Workshop User" state=present shell=/bin/bash password={{genomics_user_password}}
      
    # Create genomics user Software Directories
    - name: Create Software Dir
      file: path={{software_dir}} state=directory owner=genomics group=workshop
    - name: Create Software Source Dir
      file: path={{source_dir}} state=directory owner=genomics group=workshop
    - name: Create Workshop Directory
      file: path={{workshop_dir}} state=directory owner=genomics group=workshop
      
    - name: Installing Some Other Build Dependencies
      apt: name={{item}} state=present install_recommends=yes
      with_items:
       - libgsl0-dev
       - libsparsehash-dev
       - libhdf5-cpp-11 #blasr
       - libhdf5-dev #blasr
       - libfreetype6-dev #matplotlib
      
  tasks:
    ### Commonly Required Programs/Libraries ###
    - name: Installing bamtools
      apt: name={{item}} state=present
      with_items:
       - bamtools
       - libbamtools-dev
       - libbamtools2.4.0
       - sra-toolkit
      tags: general, alignment, assembly, genomics, seqdqc

    - name: Installing BioPerl - slow
      cpanm: name=CJFIELDS/BioPerl-1.6.924.tar.gz
      tags: general, alignment, assembly, genomics, seqdqc, bioperl

    - name: Installing BioPython
      pip: name=biopython state=present
      tags: general, alignment, assembly, genomics, seqdqc, biopython
    
    # Conda for Python 2.7
    - include: software_tasks/conda.yaml version=2 prefix=/home/genomics/miniconda
      tags: general, conda

    # Conda for Python 3.0
    - include: software_tasks/conda.yaml version=3 prefix=/home/genomics/miniconda
      tags: general, conda

    # Add Bioconda repos
    - include: software_tasks/bioconda.yaml
      tags: general, conda, bioconda

    ### Unix ###
    # Base is OK


    ### Sequencing Data Quality Control ###
    - include: software_tasks/seqtk.yaml
      tags: genomics, seqdqc, seqtk
      
    - include: software_tasks/trim_galore.yaml version=0.4.1
      tags: seqdqc, trim_galore
    
    - name: Installing cutadapt
      pip: name=cutadapt state=present
      tags: seqdqc, cutadapt

    - name: Install ea-utils 1.04.676, trimmomatic, fastqc 0.11.4
      apt: name={{item}} state=present
      with_items:
       - ea-utils
       - trimmomatic
       - fastqc
      tags: genomics, seqdqc


    ### Alignment Methods ###
    # This requires > 4GB memory to install, so we ignore the errors
    # to allow the rest of the play to run through
    - include: software_tasks/blasr.yaml
      tags: alignment, genomics, blasr
      ignore_errors: yes


    ### Genomics ###
    ## Previously Installed
    # FastQC, fastq-mcf, seqtk, blasr

    # installs bowtie 1 and 2
    - include: software_tasks/bowtie.yaml version=2.2.9
      tags: genomics, bowtie 

    - include: software_tasks/bwa.yaml
      tags: genomics, bwa
      
    - include: software_tasks/samtools.yaml version=1.3.1
      tags: genomics, samtools
    - include: software_tasks/bcftools.yaml version=1.3.1
      tags: genomics, bcftools
      
    - name: Installing blast legacy & blast+
      apt: name={{item}} state=present
      with_items:
       - ncbi-blast+
       - ncbi-blast+-legacy
       - ncbi-tools-bin
       - ncbi-tools-x11
      tags: genomics, blast
      
    - name: Installing EMBOSS tools (getorf)
      apt: name={{item}} state=present
      with_items:
       - emboss
       - emboss-data
       - emboss-doc
       - emboss-lib
       - jemboss
      tags: genomics, emboss
      
    - name: Installing FastTree2
      apt: name=fasttree state=present
      tags: fasttree
    - name: Install FastTree2 Links
      file: src=/usr/bin/fasttree dest=/usr/bin/FastTree state=link
      tags: fasttree
    - name: Install FastTree2 Links
      file: src=/usr/bin/fasttreeMP dest=/usr/bin/FastTreeMP state=link
      tags: genomics, fasttree
      
    - include: software_tasks/igv.yaml version=2.3.80
      tags: igv
    - include: software_tasks/igvtools.yaml version=2.3.80
      tags: genomics, igvtools
      
    - name: Install bedtools
      apt: name=bedtools state=present
      tags: genomics, bedtools

    - include: software_tasks/qualimap.yaml version=2.2
      tags: genomics, qualimap

    - include: software_tasks/SPAdes.yaml version=3.9.0
      tags: assembly, genomics, spades

    - include: software_tasks/quast.yaml version=4.2
      tags: assembly, genomics, quast

    - include: software_tasks/hmmer.yaml version=3.1b2
      tags: genomics, hmmer

    - name: Installing Velvet Assembler
      apt: name={{item}} state=present
      with_items:
       - velvet
       - velvet-example
      tags: assembly, genomics, velvet

    - include: software_tasks/bam2fastq.yaml version=1.1.0
      tags: genomics, bam2fastq

    - include: software_tasks/newick_utils.yaml
      tags: genomics, newick_utils

    - include: software_tasks/picard_tools.yaml
      tags: genomics, picard_tools

    - include: software_tasks/genomics_tutorial_extras.yaml
      tags: genomics, genomics_extras


    ### Genome Assembly ###
    ## Previously Installed
    # velvet, SPAdes, QUAST

    - include: software_tasks/minia.yaml version=2.0.7
      tags: assembly, minia

    - include: software_tasks/kmergenie.yaml version=1.7016
      tags: assembly, kmergenie
   
    - include: software_tasks/prokka.yaml
      tags: assembly, prokka


    ### Introduction to R ###
    ## Previously Installed
    # r and r studio

    - name: Installing littler
      apt: name=r-cran-littler state=present
      tags: r, phyloseq, littler

    - name: Installing ggplot2
      shell: "{{playbook_dir}}/scripts/install.r ggplot2"
      tags: r, ggplot2


    ### QIIME ###
    # Talk to Dan. QIIME1 or 2? Python 2 or 3. Jupyter Notebooks?
    - name: Install QIIME Dependencies
      pip: name={{item}} state=present
      with_items:
       - numpy
       - h5py
       - matplotlib
      tags: qiime, metagenomics

    
    ### PhyloSeq ###
    ## Previously Installed
    # r, r-studio-server/desktop, littler, ggplot2
    
    - include: software_tasks/phyloseq.yaml
      tags: phyloseq

    
    ### RAD-Seq / Stacks ###
    ## Previously Installed
    # MySQL in Base Install
    # PHP5?? http://askubuntu.com/questions/756181/installing-php-5-6-on-xenial-16-04

    - name: Installing Stacks Dependencies
      apt: name={{item}} state=present
      with_items:
       - libdbd-mysql-perl
       - libsparsehash-dev
       - php7.0
       - php7.0-mysql
       - python-mysqldb
       - libspreadsheet-writeexcel-perl
      tags: radseq
 
    - include: software_tasks/stacks.yaml version=1.42
      tags: radseq

    - include: software_tasks/stacks_web.yaml
      tags: radseq

    ### Transcriptomics ###
    ## Previously Installed
    # bowtie1, bioconductor, IGV, samtools

    
