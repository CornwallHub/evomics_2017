- name: Check Firefox profile exists
  command: grep -s "Name=default" ~/.mozilla/firefox/profiles.ini
  register: grep_profile
  changed_when: false
  failed_when: grep_profile.rc > 2
  become: yes
  become_user: {{workshop_user}}

- name: Ensure Firefox profile exists
  shell: xvfb-run --auto-servernum --server-num=1 firefox -no-remote -CreateProfile default 2>&1
  register: create_profile 
  changed_when: grep_profile.rc > 0
  ignore_errors: yes
  become: yes
  become_user: {{workshop_user}}

#- set_fact:
#  firefox_profile: "{{ create_profile.stdout | regex_replace(\"Success: created profile '(.+)' at '(.+)'\", \"\\2\") | dirname }}"

#- name: Install firefox user prefs
#  lineinfile:
#    dest: '{{firefox_profile}}/user.js'
#    create: yes
#    regexp: '^user_pref\("{{ item.name }}",\s*\S+?\);\s*$'
#    line: "user_pref(\"{{item.name}}\", {{ ('\"%s\"' | format(item.value)) if item.value is string else (item.value | lower) }});"
#  with_items:
#    - "// Set default homepage"
#    - "defaultPref("browser.startup.homepage","data:text/plain,browser.startup.homepage=https://evomics.org/workshops/workshop-on-genomics/2017-workshop-on-genomics-cesky-krumlov/");"
